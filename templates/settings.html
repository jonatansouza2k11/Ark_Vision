{% extends "base.html" %}

{% block title %}Configura√ß√µes - Ark{% endblock %}

{% block page_content %}

<header class="bg-dark-card border-b border-dark-border px-8 py-4">
  <h1 class="text-2xl font-bold">Configura√ß√µes</h1>
  <p class="text-sm text-gray-400 mt-1">Ajuste todos os par√¢metros de detec√ß√£o e monitoramento</p>
</header>

<div class="p-6">

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
  {% for category, message in messages %}
  <div class="mb-4 p-4 rounded-lg {% if category == 'success' %}bg-green-900{% else %}bg-yellow-900{% endif %}">
    {{ message }}
  </div>
  {% endfor %}
  {% endif %}
  {% endwith %}

  <div class="bg-dark-card rounded-2xl p-6">
    <h2 class="text-xl font-semibold mb-6">Par√¢metros YOLO e Safe Zone</h2>

    <form method="POST" class="space-y-8">

      <!-- Detec√ß√£o YOLO -->
      <div>
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">üéØ Detec√ß√£o YOLO</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <div>
            <label class="block text-sm font-medium mb-2">
              Confian√ßa M√≠nima (0.0-1.0)
              <span class="text-gray-400 text-xs ml-2">Quanto maior, menos detec√ß√µes falsas</span>
            </label>
            <input type="number" step="0.01" min="0" max="1" name="conf_thresh" value="{{ config.conf_thresh }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">
              Modelo YOLO
              <span class="text-gray-400 text-xs ml-2">Arquivos .pt em yolo_models/</span>
            </label>

            <select name="model_path"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

              {% for path in available_models %}
              {% set filename = path.split('\\')[-1].split('/')[-1] %}
              <option value="{{ path }}" {% if config.model_path==path %}selected="selected" {% endif %}>
                {{ filename }}
              </option>
              {% endfor %}

            </select>

            {% if not available_models %}
            <p class="text-xs text-yellow-300 mt-2">
              Nenhum .pt encontrado na pasta yolo_models/.
            </p>
            {% endif %}
          </div>

        </div>
      </div>

      <!-- Performance -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">‚ö° Performance</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">
              Largura do Frame (px)
              <span class="text-gray-400 text-xs ml-2">Menor = mais FPS</span>
            </label>
            <input type="number" step="10" min="480" max="1920" name="target_width" value="{{ config.target_width }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">
              Pular Frames (1 em cada N)
              <span class="text-gray-400 text-xs ml-2">2 = metade</span>
            </label>
            <input type="number" min="1" max="10" name="frame_step" value="{{ config.frame_step }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>
        </div>
      </div>

      <!-- Fonte de v√≠deo -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">üìπ Fonte de v√≠deo</h3>

        <div>
          <label class="block text-sm font-medium mb-2">
            Source (0 = webcam / URL = IP cam)
            <span class="text-gray-400 text-xs ml-2">Ex: 0 ou http://192.168.1.100:8080/video</span>
          </label>

          <input type="text" name="source" value="{{ config.get('source', '0') }}"
            placeholder="0  ou  http://192.168.1.100:8080/video"
            class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

          <p class="text-xs text-gray-400 mt-2">
            üí° Para webcam use "0". Para IP Webcam use a URL completa com /video.
          </p>
        </div>

        <div class="mt-6 grid grid-cols-1 md:grid-cols-4 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">Webcam width</label>
            <input type="number" name="cam_width" min="320" max="3840" value="{{ config.get('cam_width', 1280) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Webcam height</label>
            <input type="number" name="cam_height" min="240" max="2160" value="{{ config.get('cam_height', 720) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Webcam FPS</label>
            <input type="number" name="cam_fps" min="1" max="120" value="{{ config.get('cam_fps', 30) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Tracker</label>
            <select name="tracker"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
              <option value="botsort.yaml" {% if config.get('tracker','botsort.yaml')=='botsort.yaml'
                %}selected="selected" {% endif %}>BoT-SORT</option>
              <option value="bytetrack.yaml" {% if config.get('tracker','botsort.yaml')=='bytetrack.yaml'
                %}selected="selected" {% endif %}>ByteTrack</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Zona segura Inteligente -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">üõ°Ô∏è Zona Inteligentes</h3>
        <div class="mt-3 space-y-3">
          <p class="text-xs text-gray-500">
            As zonas s√£o desenhadas no dashboard (Safe Zone Map). Aqui voc√™ configura o
            <span class="font-semibold">modo e tempos</span> de cada uma.
          </p>

          <div class="overflow-hidden rounded-xl border border-dark-border">
            <table class="min-w-full text-xs">
              <thead class="bg-slate-800/70 text-gray-300">
                <tr>
                  <th class="px-3 py-2 text-left font-semibold">Zona</th>
                  <th class="px-3 py-2 text-left font-semibold">Modo</th>
                  <th class="px-3 py-2 text-left font-semibold">Max fora (s)</th>
                  <th class="px-3 py-2 text-left font-semibold">Cooldown e-mail (s)</th>
                  <th class="px-3 py-2 text-left font-semibold">Vazia (s)</th>
                  <th class="px-3 py-2 text-left font-semibold">Cheia (s)</th>
                  <th class="px-3 py-2 text-left font-semibold">Threshold</th>
                </tr>
              </thead>
              <tbody>
                {# usa zones_meta em vez de config.safe_zone #}
                {% if zones_meta and zones_meta|length > 0 %}
                {% for z in zones_meta %}
                <tr class="divide-y divide-slate-800">
                  <td class="px-3 py-2 font-semibold">
                    <input type="text" name="zone_{{ loop.index0 }}_name"
                      value="{% if z is mapping and z.name is defined %}{{ z.name }}{% else %}Zona {{ loop.index }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                  <td class="px-3 py-2">
                    {% set zm = 'GENERIC' %}
                    {% if z is mapping and z.mode is defined and z.mode %}
                    {% set zm = z.mode.upper() %}
                    {% endif %}
                    <select name="zone_{{ loop.index0 }}_mode"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                      <option value="GENERIC" {% if zm=='GENERIC' %}selected{% endif %}>GENERIC</option>
                      <option value="FLOW" {% if zm=='FLOW' %}selected{% endif %}>FLOW</option>
                      <option value="QUEUE" {% if zm=='QUEUE' %}selected{% endif %}>QUEUE</option>
                      <option value="CRITICAL" {% if zm=='CRITICAL' %}selected{% endif %}>CRITICAL</option>
                    </select>
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" step="0.1" min="1" name="zone_{{ loop.index0 }}_max_out"
                      value="{% if z is mapping and z.max_out_time is defined %}{{ z.max_out_time }}{% else %}{{ config.max_out_time }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" step="1" min="1" name="zone_{{ loop.index0 }}_email_cd"
                      value="{% if z is mapping and z.email_cooldown is defined %}{{ z.email_cooldown }}{% else %}{{ config.email_cooldown }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" step="1" min="1" name="zone_{{ loop.index0 }}_empty_t"
                      value="{% if z is mapping and z.empty_timeout is defined %}{{ z.empty_timeout }}{% else %}{{ config.get('zone_empty_timeout', 10.0) }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" step="1" min="1" name="zone_{{ loop.index0 }}_full_t"
                      value="{% if z is mapping and z.full_timeout is defined %}{{ z.full_timeout }}{% else %}{{ config.get('zone_full_timeout', 20.0) }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" step="1" min="1" name="zone_{{ loop.index0 }}_full_thr"
                      value="{% if z is mapping and z.full_threshold is defined %}{{ z.full_threshold }}{% else %}{{ config.get('zone_full_threshold', 5) }}{% endif %}"
                      class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                  </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                  <td colspan="7" class="px-3 py-3 text-center text-gray-500">
                    Nenhuma zona desenhada ainda. Use o modal Safe Zone Map &gt; Map no dashboard.
                  </td>
                </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>


      <!-- Alertas -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">üìß Alertas</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">Tempo M√°ximo Fora (segundos)</label>
            <input type="number" step="0.5" min="1" max="60" name="max_out_time" value="{{ config.max_out_time }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Cooldown E-mail (segundos)</label>
            <input type="number" step="1" min="5" max="300" name="email_cooldown" value="{{ config.email_cooldown }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">Buffer Pr√©-Grava√ß√£o (segundos)</label>
            <input type="number" step="0.5" min="0" max="10" name="buffer_seconds"
              value="{{ config.get('buffer_seconds', 2.0) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>
        </div>
      </div>

      <!-- Servidor de E-mail -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">üì° Servidor de E-mail (SMTP)</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium mb-2">SMTP Server</label>
            <input type="text" name="email_smtp_server" value="{{ config.get('email_smtp_server', 'smtp.gmail.com') }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div>
            <label class="block text-sm font-medium mb-2">SMTP Port</label>
            <input type="number" name="email_smtp_port" min="1" max="65535"
              value="{{ config.get('email_smtp_port', 587) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">
          </div>

          <div class="relative group">
            <label class="block text-sm font-medium mb-2">E-mail Remetente (FROM)</label>
            <input type="email" name="email_from" value="{{ config.get('email_from', 'jonatandj2k14@gmail.com') }}"
              placeholder="seu_email@gmail.com"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-80
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p class="font-semibold mb-1 text-gray-800">üìß E-mail Remetente (FROM)</p>
              <p>
                E-mail que aparecer√° como remetente nas notifica√ß√µes do sistema.
                Para Gmail, use o mesmo e-mail da conta que gerou o App Password.
                <br><br>
                <span class="font-semibold">Exemplo:</span> seu_nome@gmail.com
              </p>
            </div>
          </div>

          <div class="relative group">
            <label class="block text-sm font-medium mb-2">Usu√°rio SMTP (login)</label>
            <input type="text" name="email_user" value="{{ config.get('email_user', 'jonatandj2k14@gmail.com') }}"
              placeholder="seu_email@gmail.com"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-80
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p class="font-semibold mb-1 text-gray-800">üë§ Usu√°rio SMTP (login)</p>
              <p>
                Usu√°rio para autentica√ß√£o no servidor SMTP.
                <br><br>
                Para Gmail: use o <span class="font-semibold">e-mail completo</span> (incluindo @gmail.com).
                <br>
                Alguns provedores usam apenas o nome de usu√°rio sem dom√≠nio.
              </p>
            </div>
          </div>

          <div class="relative group">
            <label class="block text-sm font-medium mb-2">Senha / App Password</label>
            <input type="password" name="email_password" value="{{ config.get('email_password', 'isozasiyvtxvmpcb') }}"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-80
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p class="font-semibold mb-1 text-red-700">üîê Senha / App Password</p>
              <p>
                <span class="font-semibold text-red-700">‚ö†Ô∏è NUNCA use sua senha normal do e-mail!</span>
                <br><br>
                Para Gmail, gere um <span class="font-semibold">App Password</span> em:<br>
                <span class="font-mono text-xs bg-gray-200 px-1 py-0.5 rounded">myaccount.google.com/apppasswords</span>
                <br><br>
                Cole o c√≥digo de 16 caracteres gerado aqui.
              </p>
            </div>
          </div>

          <div class="flex items-center gap-6">
            <label class="flex items-center gap-2">
              <input type="checkbox" name="email_use_tls" class="checkbox checkbox-sm" {% if
                config.get('email_use_tls', '1' )=='1' %}checked{% endif %}>
              <span>Usar TLS</span>
            </label>

            <label class="flex items-center gap-2">
              <input type="checkbox" name="email_use_ssl" class="checkbox checkbox-sm" {% if
                config.get('email_use_ssl', '0' )=='1' %}checked{% endif %}>
              <span>Usar SSL</span>
            </label>
          </div>
        </div>

        <p class="mt-2 text-xs text-gray-500">
          Essas op√ß√µes s√£o edit√°veis apenas por administradores e ser√£o usadas para todos os e-mails do sistema.
        </p>
      </div>


      <!-- Zones (par√¢metros inteligentes) -->
      <div class="border-t border-dark-border pt-6">
        <h3 class="text-lg font-semibold mb-4 text-accent-blue">‚öôÔ∏è Zones</h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- zone_empty_timeout -->
          <div class="relative group">
            <label class="block text-sm font-medium mb-2">
              Zona vazia demais<br>
            </label>
            <input type="number" step="1" min="1" max="600" name="zone_empty_timeout"
              value="{{ config.get('zone_empty_timeout', 10.0) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <!-- CARD DE AJUDA -->
            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-72
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p class="font-semibold mb-1">zone_empty_timeout</p>
              <p>
                Se <span class="font-semibold">count == 0</span> nessa zona por mais tempo do que esse valor,
                ela entra em estado <span class="font-semibold">EMPTY_LONG</span>
                (ex.: √°rea que deveria ter fluxo, mas ficou vazia tempo demais).
              </p>
            </div>
          </div>

          <!-- zone_full_timeout -->
          <div class="relative group">
            <label class="block text-sm font-medium mb-2">
              Zona cheia demais (s)
            </label>
            <input type="number" step="1" min="1" max="600" name="zone_full_timeout"
              value="{{ config.get('zone_full_timeout', 20.0) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-72
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p>
                Se <span class="font-semibold">count ‚â• zone_full_threshold</span> por mais tempo do que esse valor,
                a zona entra em <span class="font-semibold">FULL_LONG</span>
                (fila/gargalo persistindo por muito tempo).
              </p>
            </div>
          </div>

          <!-- zone_full_threshold -->
          <div class="relative group">
            <label class="block text-sm font-medium mb-2">
              Limite de objetos para zona cheia
            </label>
            <input type="number" step="1" min="1" max="100" name="zone_full_threshold"
              value="{{ config.get('zone_full_threshold', 5) }}"
              class="w-full px-4 py-2 bg-dark-bg border border-dark-border rounded-lg focus:outline-none focus:ring-2 focus:ring-accent-blue text-white">

            <div class="hidden group-hover:block absolute z-20 top-full left-0 mt-2 w-72
                        bg-amber-100 border border-amber-300 rounded-xl shadow-xl p-3 text-xs text-gray-900">
              <p>
                Define a partir de quantos objetos a zona √© considerada cheia
                (ex.: 5 pessoas). Se ficar acima desse n√∫mero por mais do que
                <span class="font-semibold">zone_full_timeout</span>, vira <span class="font-semibold">FULL_LONG</span>.
              </p>
            </div>
          </div>
        </div>
      </div>



      <div class="pt-4 flex flex-wrap gap-4 items-center">
        <button type="submit"
          class="bg-accent-blue hover:bg-blue-600 text-white font-bold px-8 py-3 rounded-lg transition">
          üíæ Salvar Configura√ß√µes
        </button>

        <a href="{{ url_for('diagnostics') }}"
          class="bg-purple-700 hover:bg-purple-800 text-white font-bold px-8 py-3 rounded-lg transition inline-flex items-center gap-2">
          üîç Diagn√≥stico do Banco
        </a>

        <p class="text-sm text-gray-400 w-full mt-2">
          ‚ö†Ô∏è Reinicie o stream para aplicar mudan√ßas de c√¢mera.
        </p>
      </div>


    </form>
  </div>

  <div class="mt-6 bg-dark-card rounded-2xl p-6">
    <h3 class="text-lg font-semibold mb-3">üìä Valores Atuais</h3>

    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
      <div>
        <p class="text-gray-400">Confian√ßa</p>
        <p class="font-bold text-accent-blue">{{ config.conf_thresh }}</p>
      </div>

      <div>
        <p class="text-gray-400">Modelo</p>
        <p class="font-bold text-accent-blue">{{ config.model_path }}</p>
      </div>

      <div>
        <p class="text-gray-400">Largura Frame</p>
        <p class="font-bold text-accent-blue">{{ config.target_width }}px</p>
      </div>

      <div>
        <p class="text-gray-400">Frame Step</p>
        <p class="font-bold text-accent-blue">1/{{ config.frame_step }}</p>
      </div>

      <div>
        <p class="text-gray-400">Tempo Fora Max</p>
        <p class="font-bold text-accent-blue">{{ config.max_out_time }}s</p>
      </div>

      <div>
        <p class="text-gray-400">Cooldown Email</p>
        <p class="font-bold text-accent-blue">{{ config.email_cooldown }}s</p>
      </div>

      <div>
        <p class="text-gray-400">Zonas Inteligentes </p>
        <p class="font-bold text-accent-blue">{{ config.safe_zone }}</p>
      </div>

      <div>
        <p class="text-gray-400">Buffer</p>
        <p class="font-bold text-accent-blue">{{ config.get('buffer_seconds', 2.0) }}s</p>
      </div>

      <div>
        <p class="text-gray-400">Source</p>
        <p class="font-bold text-accent-blue">{{ config.get('source', '0') }}</p>
      </div>

      <div>
        <p class="text-gray-400">Webcam</p>
        <p class="font-bold text-accent-blue">
          {{ config.get('cam_width', 1280) }}x{{ config.get('cam_height', 720) }} @ {{ config.get('cam_fps', 30) }}
        </p>
      </div>

      <div>
        <p class="text-gray-400">Tracker</p>
        <p class="font-bold text-accent-blue">{{ config.get('tracker', 'botsort.yaml') }}</p>
      </div>
    </div>
  </div>

</div>

{% endblock %}