{% extends "base.html" %}

{% block title %}Logs - Ark{% endblock %}

{% block extra_head %}
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
<style>
  .video-preview { position: relative; cursor: pointer; }
  .video-card {
    position: fixed; display: none; z-index: 9999;
    background: #2d3748; border: 2px solid #4299e1;
    border-radius: 12px; padding: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    max-width: 600px; width: 90%; pointer-events: auto;
  }
  .video-card.show { display: block; animation: fadeIn 0.2s ease-in; }
  .video-card-title { font-size: 16px; font-weight: bold; color: #4299e1; margin-bottom: 8px; }
  .video-card-info { font-size: 12px; color: #a0aec0; margin-top: 8px; }
  .video-card-close {
    position: absolute; top: 8px; right: 8px;
    background: #e53e3e; color: white; border: none;
    border-radius: 50%; width: 28px; height: 28px;
    cursor: pointer; font-weight: bold;
    display: flex; align-items: center; justify-content: center; z-index: 10000;
  }
  .video-card-close:hover { background: #c53030; }
  .video-js { width: 100%; height: 350px; }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .video-icon { font-size: 18px; }
</style>
{% endblock %}

{% block page_content %}

<header class="bg-dark-card border-b border-dark-border px-8 py-4">
  <h1 class="text-2xl font-bold">HistÃ³rico</h1>
  <p class="text-sm text-gray-400 mt-1">Alertas com vÃ­deo e aÃ§Ãµes de controle do stream</p>
</header>

<div class="p-6">
  <div class="bg-dark-card rounded-2xl p-6">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="mb-4 space-y-2">
          {% for category, message in messages %}
            <div class="p-3 rounded-lg text-sm
                        {% if category == 'success' %}bg-green-900 text-green-100
                        {% elif category == 'warning' %}bg-yellow-900 text-yellow-100
                        {% elif category == 'danger' %}bg-red-900 text-red-100
                        {% else %}bg-slate-800 text-slate-100{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Tabela de Alertas -->
    <h2 class="text-xl font-bold mb-4">HistÃ³rico de Alertas</h2>
    <p class="text-sm text-gray-400 mb-4">Ãšltimos 50 alertas com vÃ­deos</p>

    <div class="overflow-x-auto mb-8">
      <table class="w-full text-left">
        <thead class="border-b border-dark-border">
          <tr class="text-gray-400 text-sm">
            <th class="pb-3">ID Pessoa</th>
            <th class="pb-3">Tempo Fora (s)</th>
            <th class="pb-3">Data/Hora</th>
            <th class="pb-3">E-mail Enviado</th>
            <th class="pb-3">VÃ­deo</th>
            <th class="pb-3">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          {% if alerts %}
            {% for alert in alerts %}
              <tr class="border-b border-dark-border hover:bg-dark-bg transition">
                <td class="py-3 font-semibold">ID {{ alert[0] }}</td>
                <td class="py-3">{{ "%.1f"|format(alert[1]) }} s</td>
                <td class="py-3">{{ alert[2] }}</td>
                <td class="py-3">
                  {% if alert[3] == 1 %}
                    <span class="text-green-400">âœ“ Sim</span>
                  {% else %}
                    <span class="text-gray-500">âœ— NÃ£o</span>
                  {% endif %}
                </td>
                <td class="py-3">
                  {% if alert[4] %}
                    {% set video_file = alert[4].split(',')[0].strip() if ',' in alert[4] else alert[4] %}
                    {% if video_file.endswith('.mp4') %}
                      <button
                        class="video-preview text-accent-blue hover:underline flex items-center gap-2"
                        data-video="{{ url_for('video_file', filename=video_file) }}"
                        data-person-id="{{ alert[0] }}"
                        data-time="{{ alert[2] }}"
                        onclick="openVideoPlayer(this)">
                        <span class="video-icon">ðŸŽ¬</span> Ver vÃ­deo
                      </button>
                    {% else %}
                      <span class="text-gray-500">â€”</span>
                    {% endif %}
                  {% else %}
                    <span class="text-gray-500">â€”</span>
                  {% endif %}
                </td>
                <td class="py-3">
                  {% if user and (user.role == 'admin' or user.get('role') == 'admin') %}
                    <form method="POST"
                          action="{{ url_for('delete_log') }}"
                          onsubmit="return confirm('Deseja realmente excluir este alerta?');">
                      <input type="hidden" name="person_id" value="{{ alert[0] }}">
                      <input type="hidden" name="timestamp" value="{{ alert[2] }}">
                      <button type="submit"
                              class="px-3 py-1 text-xs rounded bg-red-700 hover:bg-red-800 text-white">
                        Excluir
                      </button>
                    </form>
                  {% else %}
                    <span class="text-gray-600 text-xs">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="py-6 text-center text-gray-400">
                Nenhum alerta registrado ainda
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

    <!-- Tabela de Logs de Sistema -->
    <h2 class="text-xl font-bold mb-4">Logs de Sistema</h2>
    <p class="text-sm text-gray-400 mb-4">
      HistÃ³rico de aÃ§Ãµes de controle do stream (INICIAR, PAUSAR, RETOMAR, PARAR)
    </p>

    <div class="overflow-x-auto">
      <table class="w-full text-left">
        <thead class="border-b border-dark-border">
          <tr class="text-gray-400 text-sm">
            <th class="pb-3">AÃ§Ã£o</th>
            <th class="pb-3">UsuÃ¡rio</th>
            <th class="pb-3">Motivo</th>
            <th class="pb-3">E-mail Enviado</th>
            <th class="pb-3">Data/Hora</th>
            <th class="pb-3">AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody class="text-sm">
          {% if system_actions %}
            {% for log in system_actions %}
              {# log: (action, username, reason, timestamp, email_sent) #}
              <tr class="border-b border-dark-border hover:bg-dark-bg transition">
                <td class="py-3">
                  {% if log[0] == 'PAUSAR' %}
                    <span class="px-2 py-1 text-xs rounded bg-yellow-700 text-yellow-100 font-semibold">
                      {{ log[0] }}
                    </span>
                  {% elif log[0] == 'RETOMAR' %}
                    <span class="px-2 py-1 text-xs rounded bg-green-700 text-green-100 font-semibold">
                      {{ log[0] }}
                    </span>
                  {% elif log[0] == 'PARAR' %}
                    <span class="px-2 py-1 text-xs rounded bg-red-700 text-red-100 font-semibold">
                      {{ log[0] }}
                    </span>
                  {% elif log[0] == 'INICIAR' %}
                    <span class="px-2 py-1 text-xs rounded bg-blue-700 text-blue-100 font-semibold">
                      {{ log[0] }}
                    </span>
                  {% else %}
                    <span class="px-2 py-1 text-xs rounded bg-slate-700 text-slate-100 font-semibold">
                      {{ log[0] }}
                    </span>
                  {% endif %}
                </td>
                <td class="py-3 font-semibold">
                  {{ log[1] }}
                </td>
                <td class="py-3">
                  {{ log[2] or 'NÃ£o informado' }}
                </td>
                <td class="py-3">
                  {% if log[4] == 1 %}
                    <span class="text-green-400">âœ“ Sim</span>
                  {% else %}
                    <span class="text-gray-500">âœ— NÃ£o</span>
                  {% endif %}
                </td>
                <td class="py-3 text-gray-300">
                  {{ log[3] }}
                </td>
                <td class="py-3">
                  {% if user and (user.role == 'admin' or user.get('role') == 'admin') %}
                    <form method="POST"
                          action="{{ url_for('delete_system_log_route') }}"
                          onsubmit="return confirm('Deseja realmente excluir este log de sistema?');">
                      <input type="hidden" name="timestamp" value="{{ log[3] }}">
                      <button type="submit"
                              class="px-3 py-1 text-xs rounded bg-red-700 hover:bg-red-800 text-white">
                        Excluir
                      </button>
                    </form>
                  {% else %}
                    <span class="text-gray-600 text-xs">â€”</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="py-6 text-center text-gray-400">
                Nenhuma aÃ§Ã£o de sistema registrada ainda
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>

  </div>
</div>

<div id="video-card" class="video-card">
  <button class="video-card-close" onclick="closeVideoPlayer()">âœ•</button>
  <div class="video-card-title">VÃ­deo do Alerta</div>

  <video
    id="video-player"
    class="video-js vjs-big-play-centered"
    controls
    preload="auto">
  </video>

  <div class="video-card-info">
    <span id="video-card-person"></span><br>
    <span id="video-card-time"></span>
  </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
  const card = document.getElementById('video-card');
  const cardPerson = document.getElementById('video-card-person');
  const cardTime = document.getElementById('video-card-time');
  let player = null;

  function openVideoPlayer(button) {
    const videoUrl = button.getAttribute('data-video');
    const personId = button.getAttribute('data-person-id');
    const time = button.getAttribute('data-time');

    if (player) {
      player.dispose();
    }

    card.style.left = '50%';
    card.style.top = '50%';
    card.style.transform = 'translate(-50%, -50%)';
    card.classList.add('show');

    player = videojs('video-player', {
      controls: true,
      autoplay: false,
      preload: 'auto',
      fluid: false,
      width: 560,
      height: 350,
      sources: [{ src: videoUrl, type: 'video/mp4' }]
    });

    cardPerson.textContent = `Pessoa ID: ${personId}`;
    cardTime.textContent = `HorÃ¡rio: ${time}`;

    player.on('error', () => {
      alert('Erro ao carregar vÃ­deo: ' + (player.error()?.message || 'Desconhecido'));
    });
  }

  function closeVideoPlayer() {
    if (player) {
      player.pause();
      player.dispose();
      player = null;
    }
    card.classList.remove('show');
  }

  document.addEventListener('click', function(e) {
    if (card.classList.contains('show') &&
        !card.contains(e.target) &&
        !e.target.closest('.video-preview')) {
      closeVideoPlayer();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && card.classList.contains('show')) {
      closeVideoPlayer();
    }
  });
</script>

{% endblock %}
