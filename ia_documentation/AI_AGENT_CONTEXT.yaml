---
# ðŸ¤– ARK YOLO System - AI Agent Context (YAML Format)
# Ãšltima atualizaÃ§Ã£o: 26/12/2025
# VersÃ£o: 1.0 Production Ready
# Compatibilidade: Claude, GPT-4, Gemini, Copilot (YAML parsers)

metadata:
  name: ARK YOLO System
  description: Real-time person detection and zone monitoring with email alerts
  version: 1.0
  status: Production Ready
  language: Python 3.10+
  lastUpdated: 2025-12-26
  documentFormat: YAML (structured data)

quick_overview:
  what_is_it: |
    System that detects people via YOLOv8/v11, tracks with BoT-SORT,
    validates if they're in safe zones, and emails when they leave too long.
  
  main_components:
    - Flask web server (HTTP routing, auth, templates)
    - YOLOVisionSystem (detection, tracking, alerting)
    - SQLite database (users, alerts, config, logs)
    - Zone manager (polygon validation)
    - Notification system (email SMTP)
  
  key_files:
    app.py: 814 lines (Flask server)
    yolo.py: 810 lines (Vision system core)
    database.py: 148 lines (SQLite CRUD)
    zones.py: 143 lines (Polygon geometry)
    notifications.py: 112 lines (Email SMTP)

architecture:
  layers:
    layer_1:
      name: Presentation Layer
      file: app.py
      tech: Flask 3.0+ Jinja2 HTML5 Tailwind CSS
      responsibility: HTTP routing, session management, template rendering
      
      routes:
        - path: /
          method: GET
          auth: required
          description: Dashboard main interface
        
        - path: /video_feed
          method: GET
          auth: required
          description: MJPEG stream (real-time video)
          encoding: multipart/x-mixed-replace; boundary=frame
        
        - path: /settings
          method: GET POST
          auth: required
          admin_only: true
          description: Configuration page
        
        - path: /logs
          method: GET
          auth: required
          description: Alert history
        
        - path: /api/status
          method: GET
          auth: required
          returns: JSON
          description: System status metrics
        
        - path: /users
          method: GET DELETE
          auth: required
          admin_only: true
          description: User management
        
        - path: /login
          method: POST
          auth: not_required
          description: Authenticate user
        
        - path: /logout
          method: GET
          auth: required
          description: Clear session
        
        - path: /register
          method: POST
          auth: not_required
          description: Create new user
      
      auth_decorators:
        login_required: Verifies session['user'] exists
        admin_required: Verifies session['user']['role'] == 'admin'
    
    layer_2:
      name: Vision Layer
      file: yolo.py
      class: YOLOVisionSystem
      pattern: Singleton (get_vision_system() returns same instance)
      responsibility: Real-time detection, tracking, zone validation, alerts
      
      attributes:
        model: YOLO instance (YOLOv8 or v11)
        cap: Video capture (cv2.VideoCapture)
        track_state: Dict[int, Dict] - {track_id: {last_seen, status, out_time}}
        email_cooldown: Dict[int, float] - throttling per person
        paused: bool - pause state
        last_frame: ndarray - cache
      
      methods:
        generate_frames: Yield MJPEG frames continuously
        process_frame: Full pipeline (detect â†’ track â†’ validate â†’ alert)
        get_config: Load settings from DB (ALWAYS FRESH!)
        trigger_alert: Send email if not in cooldown
        toggle_pause: Pause video keep tracking
      
      processing_pipeline:
        step_1_preprocess: Flip horizontal, resize 960px, normalize
        step_2_yolo: Inference, confidence filter, NMS, scale
        step_3_botsort: Associate, maintain IDs, predict
        step_4_zone: Check if center in safe_zone
        step_5_state: Increment out_time if OUT, reset if IN
        step_6_alert: Check threshold and cooldown, send email
        step_7_output: Draw overlays, encode JPEG, yield MJPEG
    
    layer_3:
      name: Data Layer
      file: database.py
      tech: SQLite3 (built-in Python)
      responsibility: User auth, alert logging, config storage
      
      tables:
        users:
          columns:
            - id: INTEGER PRIMARY KEY
            - username: TEXT UNIQUE NOT NULL
            - password: TEXT NOT NULL (bcrypt hash)
            - role: TEXT DEFAULT 'user' ('admin' | 'user')
        
        alerts:
          columns:
            - id: INTEGER PRIMARY KEY
            - person_id: INTEGER NOT NULL
            - out_time: INTEGER (seconds out of zone)
            - snapshot_path: TEXT (path to alert frame)
            - email_sent: BOOLEAN DEFAULT 0
            - created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        
        settings:
          columns:
            - key: TEXT PRIMARY KEY
            - value: TEXT (dynamic configuration)
          
          example_keys:
            conf_thresh: "0.78"
            max_out_time: "30"
            target_width: "960"
            frame_step: "2"
            email_cooldown: "300"
            safe_zone: "(400,100,700,600)"
        
        system_logs:
          columns:
            - id: INTEGER PRIMARY KEY
            - level: TEXT ('INFO' | 'WARNING' | 'ERROR')
            - message: TEXT
            - created_at: TIMESTAMP DEFAULT CURRENT_TIMESTAMP

configuration:
  dynamic_settings: All loaded from database at RUNTIME (no restart needed!)
  
  settings:
    conf_thresh:
      default: 0.78
      type: float
      range: 0.5 - 0.95
      impact: YOLO confidence minimum (lower = more detections, more false positives)
    
    max_out_time:
      default: 30
      type: int
      unit: seconds
      range: 5 - 300
      impact: Alert threshold (time outside zone before email)
    
    target_width:
      default: 960
      type: int
      unit: pixels
      range: 480 - 1920
      impact: Resize width (lower = faster but less accurate)
    
    frame_step:
      default: 2
      type: int
      range: 1 - 5
      impact: Process every N-th frame (higher = faster but misses movement)
    
    email_cooldown:
      default: 300
      type: int
      unit: seconds
      range: 60 - 3600
      impact: Throttle seconds between alerts per person (prevent spam)
    
    safe_zone:
      default: "(400,100,700,600)"
      type: string
      format: "(x1,y1,x2,y2)"
      coords_in: Resized frame space (not original)
      impact: Rectangle defining safe area (people inside = safe)

yolo_models:
  available:
    yolov8n:
      size: 5.6 MB
      fps: 45
      accuracy: 78%
      memory: 50 MB
      gpu_required: false
      use_case: CPU real-time
    
    yolov8s:
      size: 22.5 MB
      fps: 35
      accuracy: 82%
      memory: 100 MB
      gpu_required: true
      use_case: Balanced
    
    yolov8m:
      size: 52 MB
      fps: 25
      accuracy: 85%
      memory: 150 MB
      gpu_required: true
      use_case: Accuracy important
    
    yolo11n:
      size: 5.8 MB
      fps: 40
      accuracy: 80%
      memory: 60 MB
      gpu_required: false
      use_case: New + fast
  
  how_to_change:
    file: yolo.py
    line: 16
    current: "MODEL_PATH = \"yolo_models/yolov8n.pt\""
    action: Change filename to desired model

camera_sources:
  webcam:
    code: "SOURCE = 0"
    alternate: "SOURCE = 1, 2, 3 for multiple cameras"
  
  ip_camera_rtsp:
    code: "SOURCE = \"rtsp://user:pass@192.168.1.100:554/stream\""
  
  ip_camera_http:
    code: "SOURCE = \"http://192.168.1.100:8080/video\""

security:
  implemented:
    - bcrypt: Password hashing (werkzeug.security)
    - sessions: Session-based auth (Flask secure cookies)
    - rbac: Role-based access control (admin/user)
    - csrf: CSRF protection (implicit Flask)
    - input_validation: Parameterized SQL queries
  
  limitations:
    - email_credentials: Hardcoded in yolo.py (MOVE TO .env)
    - flask_secret_key: Hardcoded (MOVE TO .env)
    - https: Not in dev (ADD gunicorn + nginx + SSL)
    - rate_limiting: Not implemented (ADD Flask-Limiter)

file_structure:
  root_files:
    - app.py (814 lines) Flask server
    - yolo.py (810 lines) Vision system
    - database.py (148 lines) SQLite
    - zones.py (143 lines) Zone logic
    - auth.py (36 lines) Auth decorators
    - notifications.py (112 lines) Email SMTP
    - requeriments.txt Python dependencies
    - botsort_reid.yaml Tracker config
    - .gitignore Git exclusions
    - README.md (563 lines) Professional docs
    - cv_system.db (generated at runtime)
  
  directories:
    templates: 10 HTML Jinja2 files
    yolo_models: 6 .pt files (~100 MB)
    documentation: 8 user docs
    ia_documentation: 7 AI context files
    alertas: Generated at runtime

extension_points:
  add_new_zone:
    file: zones.py
    step: Edit self.zones dict
    example: "self.zones['my_zone'] = [(100,100), (200,100), (200,200)]"
  
  add_new_setting:
    steps:
      1_html: Add form input in templates/settings.html
      2_flask: Add POST handler in app.py
      3_load: Add get_setting() in yolo.py get_config()
      4_use: Use config['my_setting'] in logic
  
  add_alert_logic:
    file: yolo.py
    method: process_detection()
    example: "if custom_condition: trigger_alert(track_id, reason)"
  
  add_api_route:
    file: app.py
    decorator: "@app.route('/api/endpoint')"
    access_control: "@login_required"
    return: "jsonify({...})"

performance:
  benchmarks_gtx_1080_ti:
    - "yolov8n @ 960px: 45 FPS"
    - "yolov8m @ 960px: 25 FPS"
    - "yolov8l @ 960px: 15 FPS"
  
  cpu_only_intel_i7_10700k:
    - "yolov8n @ 480px: 12 FPS"
    - "yolov8n @ 960px: 4 FPS (not recommended)"
  
  optimization_tips:
    - reduce_resolution: Lower target_width (480 or 640)
    - skip_frames: Increase frame_step (3 or 5)
    - smaller_model: yolov8n instead of yolov8l
    - enable_gpu: 5-10x speedup
    - pause_mode: Reduce CPU without stopping tracking

troubleshooting:
  bad_detections:
    cause: Low confidence threshold or wrong model
    solutions:
      - increase conf_thresh in settings (0.85+)
      - switch to larger model (yolov8l)
      - improve lighting
  
  slow_performance:
    cause: High resolution or large model
    solutions:
      - reduce target_width (640 or 480)
      - increase frame_step (3-5)
      - use smaller model
      - enable GPU
  
  unstable_tracking:
    cause: Low resolution or poor lighting
    solutions:
      - increase input resolution
      - improve lighting
      - adjust tracker parameters in botsort_reid.yaml
  
  no_emails:
    checks:
      - use_app_password: Not regular Gmail password
      - less_secure_apps: Enabled in Gmail settings
      - credentials_correct: Check notifications.py
      - port_open: 587 or 465
  
  camera_not_connecting:
    checks:
      - url_correct: Check camera documentation
      - credentials: If RTSP auth required
      - port: 554 (RTSP) 8080 (HTTP, common)
      - same_network: Ping IP address

execution:
  install_steps:
    - "python -m venv cv_env"
    - "source cv_env/bin/activate  # Linux/Mac"
    - "# OR cv_env\\Scripts\\Activate.ps1  # Windows"
    - "pip install -r requeriments.txt"
    - "python -c \"from database import init_db; init_db()\""
    - "python app.py"
    - "# Visit http://localhost:5000"
  
  first_login:
    access_register: True on first visit
    create_user: Yes (first user is admin)
    password_requirement: Any string

ai_agent_checklist:
  understanding:
    - [ ] "3 layers (Presentation â†’ Vision â†’ Data)"
    - [ ] "Frame pipeline (detect â†’ track â†’ validate â†’ alert)"
    - [ ] "Singleton pattern for YOLOVisionSystem"
    - [ ] "Database schema (4 tables)"
    - [ ] "YOLO model tradeoffs"
    - [ ] "Zone validation (polygon winding)"
    - [ ] "Email cooldown throttling"
    - [ ] "Settings loaded at runtime"
    - [ ] "Bcrypt + sessions + roles"
    - [ ] "Extension points (routes, settings, zones)"

references:
  external:
    yolo_docs: https://docs.ultralytics.com
    botsort_paper: https://arxiv.org/abs/2110.14652
    flask_docs: https://flask.palletsprojects.com
    opencv_docs: https://docs.opencv.org
    pytorch_docs: https://pytorch.org/docs
  
  internal:
    readme: README.md (563 lines professional overview)
    full_docs: documentation/DOCUMENTACAO.md (complete reference)
    architecture: documentation/ARQUITETURA_TECNICA.md (deep dive)
    quick_start: documentation/GUIA_RAPIDO.md (15 minutes)
  
  repository:
    url: https://github.com/jonatansouza2k11/computacional_vision
    issues: Use GitHub Issues for bugs
    branch: main (production ready)

---
# Document ends here
# Version: 1.0
# Updated: 2025-12-26
# For AI agents: Use this document as your primary reference
