################################################################################
#                   ARK YOLO - MACHINE-READABLE CONTEXT
#                        Para Agentes de IA
################################################################################

project_metadata:
  name: "ARK YOLO"
  description: "Real-time person detection + zone monitoring + alert system"
  version: "1.0"
  language: "Python 3.10+"
  framework: "Flask + YOLOv8/v11"
  license: "MIT"
  created: "2025-12"

################################################################################
#                           ARCHITECTURE OVERVIEW
################################################################################

architecture:
  description: "Three-layer system"
  layers:
    presentation:
      component: "app.py"
      lines: 814
      responsible_for:
        - "HTTP routing"
        - "Flask server"
        - "Authentication"
        - "Web templates"
        - "Session management"
      main_routes:
        - "/login (GET|POST)"
        - "/register (GET|POST)"
        - "/dashboard (GET)"
        - "/video_feed (GET)"
        - "/api/stats (GET)"
        - "/settings (GET|POST)"
        - "/alerts (GET)"
        - "/users (GET|POST)"
      key_classes: []
      key_functions:
        - "login()"
        - "register()"
        - "dashboard()"
        - "video_feed()"
    
    vision:
      component: "yolo.py"
      lines: 810
      responsible_for:
        - "YOLO detection"
        - "BoT-SORT tracking"
        - "Frame processing"
        - "Safe zone validation"
        - "Video recording"
        - "MJPEG streaming"
      key_classes:
        - "YOLOVisionSystem"
      key_methods:
        - "generate_frames()"
        - "process_detection()"
        - "toggle_pause()"
        - "get_config()"
      state_structure:
        track_state:
          type: "defaultdict"
          key_type: "int (track_id)"
          value_type: "dict"
          value_fields:
            - "last_seen (float)"
            - "status (str: IN|OUT)"
            - "out_time (float)"
            - "recording (bool)"
            - "buffer (deque)"
            - "zone_idx (int)"
            - "video_writer (cv2.VideoWriter)"
            - "video_path (str)"
    
    data:
      component: "database.py"
      lines: 148
      responsible_for:
        - "User authentication"
        - "Alert logging"
        - "Configuration storage"
        - "System logging"
      database_engine: "SQLite"
      database_file: "cv_system.db"
      tables:
        users:
          columns:
            - "id: INTEGER PRIMARY KEY"
            - "username: TEXT UNIQUE"
            - "email: TEXT UNIQUE"
            - "password_hash: TEXT (bcrypt)"
            - "role: TEXT (user|admin)"
            - "created_at: TIMESTAMP"
            - "last_login: TIMESTAMP"
        
        alerts:
          columns:
            - "id: INTEGER PRIMARY KEY"
            - "person_id: INTEGER (track_id)"
            - "out_time: REAL"
            - "snapshot_path: TEXT"
            - "email_sent: INTEGER (0|1)"
            - "timestamp: TIMESTAMP"
        
        settings:
          columns:
            - "key: TEXT PRIMARY KEY"
            - "value: TEXT"
          common_keys:
            - "conf_thresh: 0.85"
            - "model_path: yolo_models/yolov8n.pt"
            - "target_width: 1280"
            - "frame_step: 1"
            - "safe_zone: (400,100,700,600)"
            - "max_out_time: 5.0"
            - "source: 0"
            - "email_user: your@email.com"
        
        system_logs:
          columns:
            - "id: INTEGER PRIMARY KEY"
            - "action: TEXT (PAUSE|RESUME|START|STOP)"
            - "username: TEXT"
            - "reason: TEXT"
            - "email_sent: INTEGER"
            - "timestamp: TIMESTAMP"
  
  complementary_modules:
    zones:
      file: "zones.py"
      lines: 143
      class_name: "ZoneManager"
      responsibility: "Polygon-based zone detection"
      key_methods:
        - "point_zone(xc, yc) -> str|None"
        - "draw_zones(frame) -> None"
    
    notifications:
      file: "notifications.py"
      lines: 112
      class_name: "Notifier"
      responsibility: "Email alerts with SMTP"
      protocol: "SMTP TLS (port 587)"
      key_methods:
        - "send_email(to, subject, body, attachments)"
        - "send_email_background(...)"
    
    auth:
      file: "auth.py"
      lines: 36
      decorators:
        - "@login_required"
        - "@admin_required"

################################################################################
#                          TECHNICAL COMPONENTS
################################################################################

components:
  yolo:
    name: "YOLO Object Detection"
    library: "ultralytics"
    purpose: "Detect persons in video frame"
    available_models:
      - "yolov8n.pt (nano - fast, less accurate)"
      - "yolov8s.pt (small)"
      - "yolov8m.pt (medium)"
      - "yolov8l.pt (large)"
      - "yolov8x.pt (extra-large - slow, very accurate)"
      - "yolov11n.pt (v11 nano)"
      - "yolov11l.pt (v11 large)"
    configuration:
      conf_thresh: 0.85  # Confidence threshold
      class_id_person: 0
    usage_example: |
      model = YOLO("yolo_models/yolov8n.pt")
      results = model(frame, conf=0.85)
  
  botsort:
    name: "BoT-SORT Multi-Object Tracker"
    purpose: "Maintain consistent track IDs across frames"
    config_file: "botsort_reid.yaml"
    features:
      - "Kalman filter for prediction"
      - "Re-ID network for appearance matching"
      - "Persistent IDs (no reuse in session)"
    usage_example: |
      results = model.track(frame, persist=True, tracker="botsort.yaml")
      for box in results[0].boxes:
          track_id = box.id
  
  opencv:
    name: "OpenCV"
    library: "opencv-python"
    primary_uses:
      - "Frame reading/writing"
      - "Color space conversions"
      - "Image resizing"
      - "Polygon point testing"
      - "MJPEG encoding"
    key_functions:
      - "cv2.VideoCapture()"
      - "cv2.VideoWriter()"
      - "cv2.resize()"
      - "cv2.pointPolygonTest()"
      - "cv2.imread/imwrite"
  
  cameras:
    supported_sources:
      - source: "webcam"
        example: "SOURCE = 0"
        description: "Local USB/built-in camera"
      - source: "ip_camera_rtsp"
        example: 'SOURCE = "rtsp://user:pass@ip:554/stream"'
        description: "IP camera with RTSP protocol"
      - source: "ip_camera_http"
        example: 'SOURCE = "http://ip:8080/video"'
        description: "IP camera with HTTP streaming"

################################################################################
#                         DATA FLOW PIPELINE
################################################################################

data_flow:
  frame_processing_pipeline:
    step_1_capture:
      input: "Camera stream"
      operation: "cap.read()"
      output: "BGR frame (1280x720)"
    
    step_2_preprocessing:
      input: "Raw frame"
      operations:
        - "Resize to target_width (keep aspect)"
        - "Flip horizontally"
      output: "Preprocessed frame"
    
    step_3_detection:
      input: "Preprocessed frame"
      model: "YOLO"
      operation: "model(frame, conf=0.85)"
      output: "Detections [x1,y1,x2,y2,conf,class_id]"
    
    step_4_tracking:
      input: "Detections"
      model: "BoT-SORT"
      operation: "model.track(frame, persist=True)"
      output: "Detections + track_ids"
    
    step_5_zone_validation:
      input: "track_id, bbox"
      operation: |
        for each detection:
          xc = (x1 + x2) / 2
          yc = (y1 + y2) / 2
          in_zone = zm.point_zone(xc, yc)
      output: "in_zone flag per person"
    
    step_6_state_update:
      input: "track_id, in_zone"
      operation: |
        if in_zone:
          status = "IN"
          out_time = 0.0
        else:
          if was_in:
            status = "OUT"
            out_time = 0.0
          else:
            out_time += delta_time
      output: "Updated track_state"
    
    step_7_alert_decision:
      input: "out_time, max_out_time, cooldown"
      condition: "out_time > max_out_time AND cooldown passed"
      action:
        - "Save video"
        - "Take snapshot"
        - "Log to database"
        - "Send email (background thread)"
      output: "Alert if condition met"
    
    step_8_recording:
      input: "Frame (if recording=True)"
      operation: "video_writer.write(frame)"
      output: "Alert video file"
    
    step_9_streaming:
      input: "Annotated frame"
      operation: |
        frame → JPEG encode
        → Add MJPEG headers
        → Send to client
      output: "MJPEG stream"

  state_transitions:
    track_lifecycle:
      - "Frame 1: Detect person → create track_id → IN"
      - "Frame 5: Person leaves zone → status=OUT, out_time=0"
      - "Frame 7: out_time=2.0 (still OUT)"
      - "Frame 9: out_time=4.0 (still OUT)"
      - "Frame 11: out_time=6.0 > max_out_time(5.0) → ALERT!"
      - "Frame 15: Person returns → status=IN, out_time=0"
      - "Frame 50: Not detected for X frames → remove from track_state"

################################################################################
#                         CONFIGURATION SYSTEM
################################################################################

configuration:
  type: "Dynamic (database-driven)"
  source: "cv_system.db → settings table"
  refresh: "Every frame (within generate_frames loop)"
  changes_require_restart: false
  
  critical_settings:
    vision:
      conf_thresh:
        type: "float 0.0-1.0"
        default: "0.85"
        impact: "Detection sensitivity"
      
      target_width:
        type: "int pixels"
        default: "1280"
        impact: "Frame dimensions + speed"
      
      frame_step:
        type: "int"
        default: "1"
        impact: "Process every N frames (1=all, 2=half speed)"
      
      model_path:
        type: "string path"
        default: "yolo_models\\yolov8n.pt"
        impact: "Which YOLO model to use"
    
    zone:
      safe_zone:
        type: "string (tuple or JSON)"
        default: "(400, 100, 700, 600)"
        format: "(x1, y1, x2, y2) in pixels"
        impact: "Rectangle boundary of safe area"
      
      max_out_time:
        type: "float seconds"
        default: "5.0"
        impact: "Trigger alert after N seconds outside"
    
    email:
      email_user:
        type: "string email"
        impact: "Gmail account to send alerts from"
      
      email_password:
        type: "string password"
        notes: "Use Gmail App Password, NOT regular password"
        impact: "Authentication for SMTP"
      
      email_cooldown:
        type: "float seconds"
        default: "10.0"
        impact: "Wait between emails for same person"
    
    camera:
      source:
        type: "int|string"
        examples: ["0", "1", "rtsp://...", "http://..."]
        impact: "Which camera to use"
      
      cam_fps:
        type: "int"
        default: "30"
        impact: "Capture frame rate"

################################################################################
#                      KEY PATTERNS & IDIOMS
################################################################################

design_patterns:
  singleton:
    name: "YOLOVisionSystem Singleton"
    location: "yolo.py"
    usage: |
      from yolo import get_vision_system
      vs = get_vision_system()  # Always same instance
      for frame in vs.generate_frames():
          ...
  
  generator:
    name: "MJPEG Stream Generator"
    location: "app.py → video_feed()"
    usage: |
      def generate_frames():
          while True:
              frame = ...
              jpeg = encode_jpeg(frame)
              yield b'--frame\r\n' + jpeg + b'\r\n'
  
  decorator:
    name: "Route Protection"
    location: "auth.py"
    usage: |
      @app.route("/dashboard")
      @login_required
      def dashboard():
          ...
  
  defaultdict:
    name: "Track State Storage"
    location: "yolo.py → YOLOVisionSystem"
    usage: |
      track_state = defaultdict(lambda: {...})
      track_state[track_id]["out_time"] += delta
  
  context_processor:
    name: "Template Context Injection"
    location: "app.py"
    usage: |
      @app.context_processor
      def inject_user():
          return {"user": session.get("user")}

################################################################################
#                        EXTENSION POINTS
################################################################################

extension_points:
  add_setting:
    steps:
      - "Add HTML input in templates/settings.html"
      - "Process in app.py POST /settings"
      - "Use in yolo.py get_config()"
  
  add_zone:
    steps:
      - "Define polygon in zones.py ZoneManager.__init__"
      - "Use point_zone() in yolo.py"
      - "Add visualization logic"
  
  add_alert_condition:
    steps:
      - "Define condition in yolo.py process_detection()"
      - "Call notifier.send_email_background()"
      - "Log to database with log_alert()"
  
  change_model:
    steps:
      - "Copy new .pt file to yolo_models/"
      - "Update model_path in settings OR code"
      - "Restart app (if changing code)"
  
  add_log_event:
    steps:
      - "Call log_system_action() in app.py"
      - "Query in logs.html template"

################################################################################
#                          DEPLOYMENT INFO
################################################################################

deployment:
  requirements:
    python: "3.10+"
    os: "Windows | Linux | macOS"
    memory: "4GB+ (recommend 8GB)"
    gpu: "Optional (2x faster with NVIDIA)"
    disk: "2GB+ (for models + videos)"
  
  dependencies:
    core:
      - "ultralytics (YOLO)"
      - "opencv-python (cv2)"
      - "flask"
      - "numpy"
      - "torch/torchvision (implicit via ultralytics)"
    
    optional:
      - "python-dotenv (for env vars)"
      - "gunicorn (for production)"
      - "nginx (reverse proxy)"
  
  installation:
    - "Create venv: python -m venv cv_env"
    - "Activate: cv_env\\Scripts\\Activate.ps1"
    - "Install: pip install -r requeriments.txt"
    - "Init DB: python -c \"from database import init_db; init_db()\""
    - "Run: python app.py"
  
  startup:
    command: "python app.py"
    output: "Running on http://localhost:5000"
    default_user:
      note: "Create account in /register or modify database"

################################################################################
#                         QUICK REFERENCE
################################################################################

quick_reference:
  import_core_system: |
    from yolo import get_vision_system
    vs = get_vision_system()
  
  get_config: |
    from database import get_setting
    conf = float(get_setting("conf_thresh", "0.85"))
  
  update_config: |
    from database import set_setting
    set_setting("max_out_time", "10.0")
  
  send_alert: |
    notifier.send_email_background(
        to="admin@example.com",
        subject="Alert",
        body="Person left zone"
    )
  
  check_zone: |
    zone = zm.point_zone(xc, yc)
    if zone == "entrada":
        # person in entrance zone
  
  log_event: |
    log_system_action("PAUSE", "admin", "Manual pause")
  
  access_track_state: |
    track_state = vs.track_state
    out_time = track_state[track_id]["out_time"]

################################################################################
#                          SECURITY NOTES
################################################################################

security:
  known_issues:
    - "Email credentials in database (should use env vars)"
    - "SECRET_KEY in code (should use env var)"
    - "No HTTPS in development"
    - "No rate limiting"
    - "No automated backups"
  
  recommendations:
    - "Use environment variables for secrets"
    - "Enable HTTPS in production"
    - "Add Flask-Limiter for rate limiting"
    - "Regular database backups"
    - "SQL injection protection (use parameterized queries)"
    - "XSS protection (Jinja2 auto-escapes)"

################################################################################
#                            GLOSSARY
################################################################################

glossary:
  track_id: "Unique identifier for a person in current session"
  bbox: "Bounding box [x1, y1, x2, y2] of detected person"
  xc_yc: "Center point of bounding box"
  safe_zone: "Polygon area where persons should stay"
  out_time: "Seconds person has been outside safe zone"
  conf_thresh: "Confidence threshold for YOLO detections (0-1)"
  MJPEG: "Motion JPEG - streaming protocol for video"
  BoT-SORT: "Tracking algorithm combining Kalman filter + Re-ID"
  persist: "Keep track IDs even if person leaves frame temporarily"
  cooldown: "Wait period before sending next alert"

################################################################################

# Version: 1.0
# Created: 2025-12
# Format: YAML-like structured text
# Purpose: Machine-readable project context for AI agents
