================================================================================
ü§ñ ARK YOLO SYSTEM - CONTEXTO COMPLETO PARA AGENTES DE IA (PLAIN TEXT)
================================================================================

√öltima atualiza√ß√£o: 26/12/2025
Vers√£o: 1.0 Production Ready
Compatibilidade: Claude, GPT-4, Gemini, Copilot, Llama
Formato: Plain text (m√°xima compatibilidade)

================================================================================
VIS√ÉO GERAL R√ÅPIDA (TL;DR)
================================================================================

O QUE √â:
  Sistema de vis√£o computacional que:
  1. Detecta pessoas usando YOLOv8/v11
  2. Rastreia com BoT-SORT (IDs persistentes)
  3. Valida se est√£o em zona segura
  4. Envia email se sa√≠rem por muito tempo

STACK T√âCNICO:
  - Python 3.10+
  - Flask (web server)
  - YOLOv8/v11 (detection)
  - BoT-SORT (tracking)
  - SQLite3 (database)
  - OpenCV (image processing)
  - PyTorch (inference)

ARQUIVOS CR√çTICOS (linhas de c√≥digo):
  - app.py (814 linhas) - Servidor Flask + rotas HTTP
  - yolo.py (810 linhas) - L√≥gica de vis√£o (detect + track + alert)
  - database.py (148 linhas) - SQLite CRUD operations
  - zones.py (143 linhas) - Geometria de pol√≠gonos
  - notifications.py (112 linhas) - Email SMTP

================================================================================
ARQUITETURA (3 CAMADAS)
================================================================================

LAYER 1: APRESENTA√á√ÉO (Flask - app.py)
  Responsabilidade: HTTP routing, templates, session management
  
  Rotas principais:
    GET  /                  ‚Üí Dashboard (auth required)
    GET  /dashboard         ‚Üí Main interface
    GET  /video_feed        ‚Üí MJPEG stream (real-time)
    GET  /settings          ‚Üí Config page (admin only)
    POST /settings          ‚Üí Update configuration
    GET  /logs              ‚Üí Alert history
    POST /login             ‚Üí Authenticate user
    POST /logout            ‚Üí Clear session
    POST /register          ‚Üí Create new user
    GET  /api/status        ‚Üí JSON status
    GET  /api/stats         ‚Üí JSON metrics
    GET  /users             ‚Üí User list (admin only)
    DELETE /users/<id>      ‚Üí Delete user (admin only)

  Autentica√ß√£o:
    - Session-based (Flask secure cookies)
    - Bcrypt password hashing
    - Role-based access control (admin/user)

LAYER 2: VIS√ÉO COMPUTACIONAL (YOLOVisionSystem - yolo.py)
  Responsabilidade: Real-time detection, tracking, zone validation, alerts
  
  Padr√£o: SINGLETON
    ‚Üí get_vision_system() retorna mesma inst√¢ncia em todas as rotas
    ‚Üí Mant√©m estado persistente (track_state, email_cooldown)
    ‚Üí N√£o recriar a cada request (performance!)

  Atributos principais:
    self.model = YOLO(MODEL_PATH)       # YOLOv8/v11 model
    self.cap = cv2.VideoCapture(SOURCE) # C√¢mera/stream
    self.track_state = {}               # {track_id: {...}}
    self.email_cooldown = {}            # Throttling
    self.paused = False                 # Pause state
    self.last_frame = None              # Cache

  M√©todos cr√≠ticos:
    generate_frames()       ‚Üí Yield MJPEG frames continuamente
    process_frame(frame)    ‚Üí Full pipeline: detect ‚Üí track ‚Üí validate ‚Üí alert
    get_config()           ‚Üí Load settings from DB (ALWAYS FRESH!)
    trigger_alert()        ‚Üí Send email if not in cooldown
    toggle_pause()         ‚Üí Pause video but keep tracking

  Pipeline de processamento por frame:
    1. Preprocessing: flip horizontal, resize to 960px, normalize
    2. YOLO Detection: inference, confidence filter, NMS
    3. BoT-SORT Tracking: associate, maintain IDs, predict
    4. Zone Validation: check if center point in safe_zone
    5. State Management: increment out_time if OUT, reset if IN
    6. Alert Logic: if out_time > threshold AND cooldown passed ‚Üí email
    7. Output Encoding: draw overlays, encode JPEG, yield MJPEG

LAYER 3: DADOS (SQLite - database.py)
  Responsabilidade: User auth, alert logging, configuration storage
  
  Tabelas:
    users:
      id INTEGER PRIMARY KEY
      username TEXT UNIQUE NOT NULL
      password TEXT NOT NULL (bcrypt hash)
      role TEXT DEFAULT 'user' ('admin' | 'user')

    alerts:
      id INTEGER PRIMARY KEY
      person_id INTEGER NOT NULL
      out_time INTEGER (seconds out of zone)
      snapshot_path TEXT (path to alert frame)
      email_sent BOOLEAN DEFAULT 0
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP

    settings:
      key TEXT PRIMARY KEY
      value TEXT (dynamic configuration)
      
      Exemplo de chaves:
        conf_thresh: 0.78          (YOLO confidence)
        max_out_time: 30           (alert trigger seconds)
        target_width: 960          (resize width pixels)
        frame_step: 2              (process every N frames)
        email_cooldown: 300        (throttle seconds)
        safe_zone: "(400,100,700,600)" (x1,y1,x2,y2)

    system_logs:
      id INTEGER PRIMARY KEY
      level TEXT ('INFO' | 'WARNING' | 'ERROR')
      message TEXT
      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP

================================================================================
COMPONENTES T√âCNICOS DETALHADOS
================================================================================

1. YOLOVisionSystem (yolo.py - 810 linhas)
   
   Responsabilidade: Core da l√≥gica de vis√£o + tracking + alertas
   
   Padr√£o Singleton:
     _vision_system = None
     
     def get_vision_system():
       global _vision_system
       if _vision_system is None:
         _vision_system = YOLOVisionSystem()
       return _vision_system
   
   Uso em app.py:
     vs = get_vision_system()  # Mesma inst√¢ncia sempre!
     frame = vs.get_frame()
   
   Ciclo de vida por frame:
     1. Capture frame from camera
     2. Preprocess (flip, resize, normalize)
     3. YOLO inference
     4. BoT-SORT update
     5. For each track:
        a. Get center point
        b. Check if in safe_zone
        c. Update state (IN/OUT)
        d. Check alert threshold
        e. Send email if needed
     6. Draw detections on frame
     7. Encode to JPEG
     8. Yield with MJPEG headers

2. Flask Application (app.py - 814 linhas)
   
   Responsabilidade: HTTP routing, template rendering, session management
   
   Decoradores customizados:
     @login_required    ‚Üí Verifica session['user'] exists
     @admin_required    ‚Üí Verifica session['user']['role'] == 'admin'
   
   Fluxo de autentica√ß√£o:
     POST /register
       ‚Üí Validar username √∫nico
       ‚Üí Hash password com bcrypt
       ‚Üí INSERT INTO users
     
     POST /login
       ‚Üí Get user from DB
       ‚Üí Check bcrypt hash
       ‚Üí SET session['user'] = {...}
       ‚Üí Redirect /dashboard
     
     GET /logout
       ‚Üí DEL session['user']
       ‚Üí Redirect /login

3. Database Layer (database.py - 148 linhas)
   
   Responsabilidade: SQLite CRUD operations
   
   Fun√ß√µes principais:
     init_db()                  ‚Üí CREATE tables if not exist
     get_user(username, pwd)    ‚Üí Authenticate
     set_setting(key, val)      ‚Üí UPDATE/INSERT config
     get_setting(key, default)  ‚Üí SELECT config
     log_alert(person_id, time) ‚Üí INSERT alert
     get_alerts(limit=50)       ‚Üí SELECT recent alerts
   
   Padr√£o:
     def get_connection():
       return sqlite3.connect('cv_system.db')

4. Zone Manager (zones.py - 143 linhas)
   
   Responsabilidade: Polygon-based zone validation
   
   Estrutura:
     class ZoneManager:
       zones = {
         'entrada': [(x1,y1), (x2,y2), (x3,y3), ...],
         'corredor_esq': [...],
         'elevador_1': [...],
       }
       
       def point_zone(self, point, zone_name):
         # Winding number algorithm
         # Returns True if point inside polygon

5. Notifications (notifications.py - 112 linhas)
   
   Responsabilidade: Email SMTP (Gmail)
   
   Uso:
     notifier = Notifier()
     notifier.send_email_background(
       to_email='person@gmail.com',
       subject='Alert: Person left zone!',
       body='Person 123 was out of zone for 35 seconds.',
       attachment_path='alertas/snapshot.jpg'
     )
   
   M√©todo: Background threading (n√£o bloqueia video)

================================================================================
CONFIGURA√á√ïES DIN√ÇMICAS (RUNTIME)
================================================================================

Todas carregadas do database.settings em CADA ciclo de frame!
(N√£o precisa reiniciar aplica√ß√£o para mudar)

Configura√ß√£o          | Default | Tipo    | Range      | Impacto
---------------------|---------|---------|------------|---------------------------
conf_thresh          | 0.78    | float   | 0.5-0.95   | YOLO confidence m√≠nima
max_out_time         | 30      | int     | 5-300      | Segundos fora zona
target_width         | 960     | int     | 480-1920   | Resize width (menor=mais r√°pido)
frame_step           | 2       | int     | 1-5        | Processar cada N frames
email_cooldown       | 300     | int     | 60-3600    | Segundos entre alertas/pessoa
safe_zone            | "(...)" | str     | "(x1,y1,x2,y2)" | Rectangle coordenadas

Cuidado: Valores muito agressivos causam:
  - Muitos alertas: aumentar max_out_time e email_cooldown
  - Detec√ß√µes ruins: aumentar conf_thresh ou usar modelo maior
  - Performance ruim: reduzir target_width, aumentar frame_step

================================================================================
MODELOS YOLO - SELE√á√ÉO & PERFORMANCE
================================================================================

Modelo      | FPS  | Accuracy | Memory | GPU Req | Use Case
------------|------|----------|--------|---------|------------------
yolov8n     | 45   | 78%      | 50 MB  | Opt     | CPU realtime
yolov8s     | 35   | 82%      | 100 MB | Yes     | Balanced
yolov8m     | 25   | 85%      | 150 MB | Yes     | Accuracy important
yolov8l     | 15   | 87%      | 250 MB | Yes     | High accuracy
yolo11n     | 40   | 80%      | 60 MB  | Opt     | New + fast
yolo11m     | 28   | 86%      | 160 MB | Yes     | New balanced

Como mudar modelo (yolo.py linha 16):
  MODEL_PATH = "yolo_models/yolov8n.pt"  ‚Üê CHANGE THIS

Regra de ouro:
  CPU-only? Use nano (yolov8n) e reduzir target_width
  GPU? Use small/medium (yolov8s/m) para balance
  Accuracy critical? Use large (yolov8l)

================================================================================
FONTE DE V√çDEO (CAMERA SOURCE)
================================================================================

Webcam (padr√£o):
  SOURCE = 0  # ou 1, 2, 3 para m√∫ltiplas webcams

IP Camera RTSP:
  SOURCE = "rtsp://username:password@192.168.1.100:554/stream"

IP Camera HTTP:
  SOURCE = "http://192.168.1.100:8080/video"

Troubleshooting c√¢mera:
  - URL errada? Procure documenta√ß√£o da c√¢mera
  - Credenciais erradas? Tente sem auth
  - Porta errada? RTSP=554, HTTP=8080 (comum)
  - Mesmo network? Ping IP para verificar

================================================================================
SEGURAN√áA - IMPLEMENTADO
================================================================================

‚úÖ IMPLEMENTADO:
   - Bcrypt password hashing (werkzeug.security)
   - Session-based auth (Flask secure cookies)
   - Role-based access control (admin/user)
   - CSRF protection (impl√≠cito no Flask)
   - Input sanitization via SQLite parameterized queries

‚ö†Ô∏è LIMITA√á√ïES CONHECIDAS:
   - Email credentials hardcoded em yolo.py (MOVER PARA .env)
   - Flask SECRET_KEY hardcoded (MOVER PARA .env)
   - Sem HTTPS em desenvolvimento (ADD gunicorn + nginx + SSL)
   - Sem rate limiting (ADD Flask-Limiter)

Production Setup (recomendado):
  1. Mover credentials para .env
  2. Use gunicorn: gunicorn -w 4 app:app
  3. Reverse proxy com nginx + SSL
  4. Add Flask-Limiter para brute force protection
  5. Enable secure session cookies:
     SESSION_COOKIE_SECURE=True
     SESSION_COOKIE_HTTPONLY=True
     SESSION_COOKIE_SAMESITE=Lax

================================================================================
COMO EXECUTAR
================================================================================

Pr√©-requisitos:
  - Python 3.10+
  - Webcam ou IP camera
  - 4GB RAM m√≠nimo (8GB recomendado)
  - GPU opcional (CPU funciona, mais lento)

Passo 1: Setup virtualenv
  python -m venv cv_env
  source cv_env/bin/activate          # Linux/Mac
  # OR
  cv_env\Scripts\Activate.ps1         # Windows PowerShell

Passo 2: Install dependencies
  pip install -r requeriments.txt

Passo 3: Initialize database
  python -c "from database import init_db; init_db()"

Passo 4: Run application
  python app.py
  # Vai rodar em http://localhost:5000

Passo 5: Access
  - Browser: http://localhost:5000
  - Login: crie credenciais na p√°gina /register
  - Padr√£o: primeiro usu√°rio √© admin automaticamente

================================================================================
ESTRUTURA DO PROJETO
================================================================================

project/
‚îú‚îÄ‚îÄ app.py                              # Flask server (814 linhas)
‚îú‚îÄ‚îÄ yolo.py                             # Vision system (810 linhas)
‚îú‚îÄ‚îÄ database.py                         # SQLite (148 linhas)
‚îú‚îÄ‚îÄ zones.py                            # Zone logic (143 linhas)
‚îú‚îÄ‚îÄ auth.py                             # Auth decorators (36 linhas)
‚îú‚îÄ‚îÄ notifications.py                    # Email SMTP (112 linhas)
‚îú‚îÄ‚îÄ requeriments.txt                    # Python dependencies
‚îú‚îÄ‚îÄ botsort_reid.yaml                   # Tracker configuration
‚îú‚îÄ‚îÄ .gitignore                          # Git exclusions
‚îú‚îÄ‚îÄ README.md                           # Professional docs (563 linhas)
‚îÇ
‚îú‚îÄ‚îÄ templates/ (10 HTML files)
‚îÇ   ‚îú‚îÄ‚îÄ base.html                       # Base layout
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.html                  # Main interface
‚îÇ   ‚îú‚îÄ‚îÄ settings.html                   # Configuration
‚îÇ   ‚îú‚îÄ‚îÄ login.html, register.html       # Auth
‚îÇ   ‚îú‚îÄ‚îÄ logs.html                       # Alert history
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ yolo_models/ (6 .pt files ~100MB total)
‚îÇ   ‚îú‚îÄ‚îÄ yolov8n.pt (5.6 MB)
‚îÇ   ‚îú‚îÄ‚îÄ yolov8s.pt (22.5 MB)
‚îÇ   ‚îú‚îÄ‚îÄ yolo11n.pt (5.8 MB)
‚îÇ   ‚îî‚îÄ‚îÄ ... (only small models in repo)
‚îÇ
‚îú‚îÄ‚îÄ documentation/ (8 user docs)
‚îÇ   ‚îú‚îÄ‚îÄ DOCUMENTACAO.md                 # Complete reference
‚îÇ   ‚îú‚îÄ‚îÄ ARQUITETURA_TECNICA.md          # Deep dive
‚îÇ   ‚îú‚îÄ‚îÄ GUIA_RAPIDO.md                  # 15min start
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ ia_documentation/ (7 AI context files)
‚îÇ   ‚îú‚îÄ‚îÄ CONTEXTO_COMPLETO_PARA_IA.md    # YOU ARE HERE
‚îÇ   ‚îú‚îÄ‚îÄ CONTEXT_FOR_AI_AGENTS.txt       # Plain text version
‚îÇ   ‚îú‚îÄ‚îÄ AI_AGENT_CONTEXT.yaml           # YAML format
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ cv_system.db                        # SQLite (generated at runtime)
‚îî‚îÄ‚îÄ alertas/                            # Generated at runtime
    ‚îî‚îÄ‚îÄ alerta_*.mp4                    # Alert snapshots

================================================================================
EXTENS√ÉO DO SISTEMA - COMO MODIFICAR
================================================================================

1. ADICIONAR NOVA ZONA
   
   Arquivo: zones.py
   
   Antes:
     self.zones = {
       'entrada': [...],
       'corredor_esq': [...],
     }
   
   Depois:
     self.zones = {
       'entrada': [...],
       'corredor_esq': [...],
       'minha_zona': [(100,100), (200,100), (200,200), (100,200)],
     }
   
   Usar em yolo.py:
     if self.zone_manager.point_zone(center_point, 'minha_zona'):
       status = "IN"

2. ADICIONAR NOVO SETTING (Configura√ß√£o)
   
   Passo 1: HTML form em templates/settings.html
     <input type="text" name="my_setting" value="{{ my_value }}">
   
   Passo 2: POST handler em app.py
     @app.route('/settings', methods=['POST'])
     def update_settings():
       set_setting('my_setting', request.form.get('my_setting'))
   
   Passo 3: Load em yolo.py get_config()
     config['my_setting'] = get_setting('my_setting', 'default_value')
   
   Passo 4: Use em generate_frames()
     if config['my_setting'] == 'value':
       # Sua l√≥gica

3. ADICIONAR L√ìGICA CUSTOMIZADA DE ALERTA
   
   Arquivo: yolo.py process_detection()
   
   Exemplo (alertar se pessoa se move muito r√°pido):
     # Ap√≥s linha check de out_time:
     if velocity > MAX_VELOCITY:
       trigger_alert(track_id, f"High velocity: {velocity}")

4. ADICIONAR NOVA ROTA API
   
   Arquivo: app.py
   
   Exemplo:
     @app.route('/api/my_endpoint', methods=['GET'])
     @login_required
     def my_endpoint():
       vs = get_vision_system()
       result = vs.some_method()
       return jsonify({'data': result})

5. ADICIONAR NOVA COLUNA AO DATABASE
   
   Arquivo: database.py init_db()
   
   Exemplo (adicionar "location" em alerts):
     cursor.execute('''CREATE TABLE alerts (
       ...
       location TEXT,
       ...
     )''')

================================================================================
TROUBLESHOOTING & PERFORMANCE TIPS
================================================================================

PROBLEMA: Detec√ß√µes muito ruins
SOLU√á√ÉO: 
  - Aumentar conf_thresh no settings (0.85+)
  - Trocar para modelo maior (yolov8l ao inv√©s yolov8n)
  - Melhorar ilumina√ß√£o

PROBLEMA: Sistema muito lento (baixo FPS)
SOLU√á√ÉO:
  - Reduzir target_width em settings (640 ou 480)
  - Aumentar frame_step (3 ou 5)
  - Usar modelo menor
  - Ativar GPU

PROBLEMA: IDs de track pulando muito
SOLU√á√ÉO:
  - Aumentar resolu√ß√£o de entrada
  - Melhorar ilumina√ß√£o
  - Ajustar max_age em botsort_reid.yaml

PROBLEMA: Emails n√£o chegam
VERIFICAR:
  - Usar Gmail app password (N√ÉO senha normal)
  - "Less secure apps" habilitado em Gmail
  - Credenciais SMTP corretas em notifications.py
  - Port 587 ou 465 aberto

PROBLEMA: C√¢mera n√£o conecta
VERIFICAR:
  - URL RTSP/HTTP correta (check c√¢mera docs)
  - Credenciais se aplic√°vel
  - Port correta (554=RTSP, 8080=HTTP comum)
  - Mesmo network

PERFORMANCE: CPU vs GPU
  - CPU: m√°ximo 10-15 FPS (yolov8n)
  - GPU GTX 1080: ~45 FPS (yolov8n), ~25 FPS (yolov8m)
  - GPU RTX 3080: ~80+ FPS (yolov8l)

Dica: Frame step = 2 processa CADA 2¬∫ frame (metade do trabalho)
      Bom para monitoramento n√£o-cr√≠tico (salva 50% CPU)

================================================================================
PARA AGENTES DE IA - CHECKLIST PR√â-MODIFICA√á√ÉO
================================================================================

Antes de fazer ANY change, verifique:

[ ] Entendi que existem 3 CAMADAS (Flask ‚Üí YOLOVisionSystem ‚Üí SQLite)
[ ] Entendi que YOLOVisionSystem √© SINGLETON (mesma inst√¢ncia sempre)
[ ] Entendi que settings s√£o carregados em CADA ciclo (load fresco!)
[ ] Entendi que track_state √© um dict {track_id: {last_seen, status, out_time}}
[ ] Entendi que safe_zone √© um RET√ÇNGULO (x1,y1,x2,y2) em espa√ßo redimensionado
[ ] Entendi que email_cooldown THROTTLES alertas (n√£o spam!)
[ ] Entendi que bcrypt HASH passwords (n√£o plaintext)
[ ] Entendi que YOLO models t√™m trade-offs (speed vs accuracy)
[ ] Entendi como adicionar NOVAS ROTAS (@app.route + @login_required)
[ ] Entendi como adicionar NOVOS SETTINGS (form ‚Üí POST ‚Üí load ‚Üí use)

Se N√ÉO entendeu algum item, releia a se√ß√£o relevante acima!

================================================================================
REFER√äNCIAS & LINKS
================================================================================

Documenta√ß√£o:
  - README.md (563 linhas) - Professional overview com badges, architeture
  - documentation/DOCUMENTACAO.md - Complete technical reference
  - documentation/ARQUITETURA_TECNICA.md - Deep dive na arquitetura
  - documentation/GUIA_RAPIDO.md - Get started in 15 minutes

Externas:
  - YOLO Docs: https://docs.ultralytics.com
  - BoT-SORT Paper: https://arxiv.org/abs/2110.14652
  - Flask: https://flask.palletsprojects.com
  - OpenCV: https://docs.opencv.org
  - PyTorch: https://pytorch.org/docs

GitHub:
  - Repository: https://github.com/jonatansouza2k11/computacional_vision
  - Issues: Use GitHub Issues para bugs

================================================================================
FIM DO DOCUMENTO
================================================================================

√öltima atualiza√ß√£o: 26/12/2025
Compat√≠vel com: Claude 3+, GPT-4, Gemini Pro, Copilot Pro, Llama 2+
Tamanho: ~60 KB otimizado

Use este documento como sua refer√™ncia principal.
Volte aqui ANTES de fazer qualquer modifica√ß√£o ao sistema!
